#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'nokogiri'
require 'active_support'
require 'bsmart'

if ARGV.size == 0
  puts "Usage: bsmart-list-stock catalog.xml [options]"
  exit 0
end

putter       = Bsmart::TabbedPutter.new(STDOUT)
catalog_file = ARGV[0]
catalog      = Nokogiri::XML(File.read(catalog_file))

if ARGV[1] == '-s'
  xpath = "/catalog/supplier[substring(@name, 1, 4)='#{ARGV[2]}']"
else
  xpath = "/catalog/supplier"
end

catalog.xpath(xpath).each do |supplier|
  putter.puts 'Supplier:'
  putter.tab!

  putter.puts("Code: #{supplier['name'][0..3]}")
  putter.puts("Name: #{supplier['name'][7..supplier['name'].length].strip}")
  putter.puts("Products:")

  supplier.xpath("product[Reference != '']").each do |product|
    putter.tab!
    putter.puts("Product:")
    putter.tab!

    product.children.each do |attribute|
      unless attribute.name == "text"
        if attribute.name == "Rsp"
          val = "%0.2f" % attribute.text.to_f
        else
          val = attribute.text
        end
        putter.puts("#{attribute.name}: #{val}")
      end
    end

    putter.un_tab!
    putter.un_tab!
  end
end
